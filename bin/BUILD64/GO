ORG=`pwd`

[ !  -d env_src ] && echo no env_src && exit 1

# We touch the file .build64 that tells that patch has been applied
touch .build64

# Apply patch
cp -r bin/BUILD64/patch/*  .
cp bin/BUILD64/Modifie bin/BUILD64/replace_int_entier.py bin/BUILD64/replace_int_entier_mc.py bin/BUILD64/GO .

# Apply Modifie script and exclude many file extensions that should not be edited if possible
# arch.h is already compatible with BUILD64, it provides from patch, so we do not edit it
./Modifie $(find src -type f -not -name "*.f" -not -name "*.txt" -not -name "*.include" -not -name "*.sh" -not -name "arch.h")

./Modifie $(find Outils/lata2dx/lata2dx -not -name "*.py" )
./Modifie Outils/lata2dx/lata_dx_filter.cpp


# Perform supplementary sed on some files
sed "s/long long long/long long/" -i Outils/lata2dx//lata2dx/commun_triou/LataDB.cpp
sed s"/long compare_indirect/int compare_indirect/" -i  Outils/lata2dx//lata2dx/commun_triou/Lata_tools.cpp

sed "s/long fonction/int fonction/" -i Outils/lata2dx/lata2dx/triou_compat/ArrOf*.cpp 
sed "s/long main(long/int main(int/" -i  Outils/lata2dx/lata2dx//*cpp

sed -i "s/<< type_codage <</<</g" src/Kernel/Framework/Equation_base.cpp
sed -i "s/%d/%ld/g" src/PolyMAC/Zones/Zone_PolyMAC.cpp
sed -i "s/vector<long> P_c(nv + 1), P_l(nv), A_c, A_l;/vector<long long> P_c(nv + 1), P_l(nv), A_c, A_l;/" src/PolyMAC/Zones/Zone_PolyMAC.cpp
sed -i "s/%d/%ld/g" src/CoviMAC/Zones/Zone_CoviMAC.cpp

sed -i "s/std::vector< std::pair<long,long> > time_steps_;/std::vector< std::pair<int,int> > time_steps_;/" src/Kernel/MEDimpl/Champ_Fonc_MED.h
sed -i "s/std::vector< std::pair<long,long> > tst = ft1->getTimeSteps(tps);/std::vector< std::pair<int,int> > tst = ft1->getTimeSteps(tps);/" src/Kernel/MEDimpl/Champ_Fonc_MED_Table_Temps.cpp
sed -i "s/std::vector<long> nel = file->getNonEmptyLevels();/std::vector<int> nel = file->getNonEmptyLevels();/" src/Kernel/MEDimpl/LireMED.cpp
sed -i "s/std::vector< std::pair< std::pair< long, long >, double > > ts = GetAllFieldIterations(file_name, field_name);/std::vector< std::pair< std::pair< int, int >, double > > ts = GetAllFieldIterations(file_name, field_name);/" src/Kernel/MEDimpl/EcrMED.cpp

sed -i "s/long \*p = afield._connectivity = new True_int\[afield._nb_elems \* afield._nodes_per_elem\];/int *p = afield._connectivity = new True_int[afield._nb_elems * afield._nodes_per_elem];/" src/Kernel/Champs/Champ_input_P0.cpp
sed -i "s/long \*pf = p + afield._nodes_per_elem; \/\/fin de la ligne/int *pf = p + afield._nodes_per_elem; \/\/fin de la ligne/" src/Kernel/Champs/Champ_input_P0.cpp

sed -i "s/long \*p = afield._connectivity = new True_int\[afield._nb_elems \* afield._nodes_per_elem\];/int *p = afield._connectivity = new True_int[afield._nb_elems * afield._nodes_per_elem];/" src/Kernel/ICoCo/Convert_ICoCoTrioField.cpp

sed -i "s/Cerr << \"Detecting a \" << mesh->getMeshDimension() << \"D mesh in \" << dim << \"D space.\" << finl;/Cerr << \"Detecting a \" << (long)mesh->getMeshDimension() << \"D mesh in \" << dim << \"D space.\" << finl;/" src/Kernel/MEDimpl/LireMED.cpp

sed -i "s/std::vector< std::vector< std::pair<INTERP_KERNEL::NormalizedCellType,long> > > res = MEDCoupling::GetUMeshGlobalInfo(filename, meshname, meshDim, spacedim, nnodes);/std::vector< std::vector< std::pair<INTERP_KERNEL::NormalizedCellType,int> > > res = MEDCoupling::GetUMeshGlobalInfo(filename, meshname, meshDim, spacedim, nnodes);/" Outils/lata2dx/lata2dx/commun_triou/LataDBmed.h
sed -i "s/void latadb_get_info_mesh_med(const char\* filename,const char\* meshname,med_geometry_type& type_geo,long& ncells,long& nnodes,long& spacedim, long &nbcomp,long& is_structured, std::vector<long>& NIJK)/void latadb_get_info_mesh_med(const char* filename,const char* meshname,med_geometry_type\& type_geo,long\& ncells,long\& nnodes,int\& spacedim, long \&nbcomp,long\& is_structured, std::vector<long>\& NIJK)/" Outils/lata2dx/lata2dx/commun_triou/LataDBmed.h
sed -i "s/long meshDim;/int meshDim;/" Outils/lata2dx/lata2dx/commun_triou/LataDBmed.h
sed -i "s/long spacedim;/int spacedim;/" Outils/lata2dx/lata2dx/commun_triou/LataDBmed.h
sed -i "s/vector<pair< long, long > > iters= MEDCoupling::GetFieldIterations(ltypes\[t\],filename,meshname.getString(),fields\[i\].c_str());/vector<pair< int, int > > iters= MEDCoupling::GetFieldIterations(ltypes[t],filename,meshname.getString(),fields[i].c_str());/" Outils/lata2dx/lata2dx/commun_triou/LataDBmed.h
sed -i "s/vector<pair<pair<long,long>,double> > vtimes=MEDCoupling::GetAllFieldIterations(filename,\/\*meshname,\*\/fields\[i\].c_str());/vector<pair<pair<int,int>,double> > vtimes=MEDCoupling::GetAllFieldIterations(filename,\/\*meshname,\*\/fields[i].c_str());/" Outils/lata2dx/lata2dx/commun_triou/LataDBmed.h
sed -i "s/vector<pair<pair<long,long>,double> > vtimes=MEDCoupling::GetAllFieldIterations(fld.filename_.getString(),fieldname.getString());/vector<pair<pair<int,int>,double> > vtimes=MEDCoupling::GetAllFieldIterations(fld.filename_.getString(),fieldname.getString());/" Outils/lata2dx/lata2dx/commun_triou/LataDBmed.h

