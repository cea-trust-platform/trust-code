#!/bin/bash
# Script pour alleger les fichiers des includes
add_first_include_in_cpp_files()
{
   for fichier in `$TRUST_Awk '/Looking for .cpp files whose first include/ {getline;while(NF==3) {print $1;getline}}' $log`
   do
      file=`Find $fichier`
      include=${fichier%cpp}h
      # On verifie que c'est un fichier TRUST qui est editable, que l'include existe
      if [ "$file" != "" ] && [ "`grep 'DO NOT EDIT' $file`" = "" ] && [ "`Find $include`" != "" ]
      then
         CHECKOUT $file 1>/dev/null 2>&1
	 cat $file | $TRUST_Awk -v include=$include 'BEGIN {premier=1} /#include / && (premier==1) {print "#include <"include">";premier=0} ($2!="<"include">") {print $0}' > $TRUST_TMP/tmp$fichier
         echo "include $include place en tete dans $fichier"
         cat $TRUST_TMP/tmp$fichier > $file 
      fi 
   done	
}

suppress_include_duplicated()
{
   # Supprime les include dupliques dans les fichiers: marche a 100% !
   for files in `$TRUST_Awk '/Looking for duplicate includes in/ {getline;while(NF==3) {print $1"|"$3;getline}}' $log`
   do
      #echo $files
      fichier=`echo $files | $TRUST_Awk -F"|" '{print $1}'`
      include=`echo $files | $TRUST_Awk -F"|" '{print $2}'`
      file=`Find $fichier`
      # On verifie que c'est un include TRUST, que ce n'est pas le .h du .cpp, que c'est un fichier editable, que ce n'est pas un fichier special
      if [ "$file" != "" ] && [ "`Find $include`" != "" ] && [ ${fichier%.cpp} != ${include%.h} ] && [ "`grep 'DO NOT EDIT' $file`" = "" ] && [ $fichier != ArrOf_Scalar_Prototype.h ]
      then         
         cd `dirname $file`
         $TRUST_Awk -v include=$include '!/#include/ || !($2=="<"include">") {print $0}' $fichier > $TRUST_TMP/tmp$fichier
         echo "include $include supprime dans $fichier"
         CHECKOUT $fichier 1>/dev/null 2>&1
         cat $TRUST_TMP/tmp$fichier > $fichier 
	 cd - 1>/dev/null 2>&1
      fi
   done
}
# Genere la doc avec Doxygen
log=perlmod/analyze_includes.log
if [ ! -f $log ] || [ $exec -nt $log ]
then
   echo "Creating Doxygen doc..."
   doxygen $TRUST_ROOT/bin/KSH/Doxyfile 1>doxygen.log 2>&1
   # On efface pour eviter de prendre trop de place
   rm -r -f html latex
   if [ -d perlmod ]
   then
      cd perlmod     
      # Probleme avec med++
      echo $ECHO_OPTS "1,$ s?med++?med\\\\\+\\\\\+?g\nw" | ed DoxyDocs.pm
      $TRUST_ROOT/bin/admin/analyze_includes.pl 2>&1 | tee `basename $log`
      rm -f DoxyDocs.pm
      cd -
      cat $log
      echo "error Doxygen: Etude des includes TRUST sous `pwd`"
   fi
fi
if [ "$1" = -fix ]
then
   add_first_include_in_cpp_files
   suppress_include_duplicated
fi

