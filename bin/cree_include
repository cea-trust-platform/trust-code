#!/bin/bash
# Depuis 11/01 les includes hors gestion de conf
# Creation d'un sous repertoire contenant un lien vers tous les includes
[ "$TRUST_ROOT" = "" ] && echo "Initialize TRUST environment" && exit -1
echo "Updating $TRUST_ROOT/include directory..."
# Creation de ce qui n'existe peut etre pas :
cd $TRUST_ROOT
INC=$TRUST_ROOT/include && [ ! -d $INC ] && mkdir $INC 2>/dev/null
cd $INC
mkdir -p $INC/backward

# Ajout des fichiers deprecated by TRUST 1.8.5:
for file in ArrOfDouble.h ArrOfInt.h DoubleVect.h IntVect.h DoubleTab.h IntTab.h DoubleTrav.h IntTrav.h DoubleList.h IntList.h DoubleLists.h IntLists.h Champ_Tabule_Morceaux.h
do
echo "#error File $file deprecated in TRUST 1.8.5. You SHOULD change the include. See TRUST_ROOT/DEVELOPER_NOTES for more information" > backward/$file
done

# Ouverture de $INC
echo "s?$MPI_INCLUDE/mpi\.h?\$(MPI_INCLUDE)/mpi\.h?g">.tmp
echo "s?$METIS_ROOT/include/metis\.h?\$(METIS_ROOT)/include/metis\.h?g">>.tmp
echo "s?$TRUST_LATAFILTER/include/?\$(TRUST_LATAFILTER)/include/?g">>.tmp
echo "s?$TRUST_ICOCOAPI/include/?\$(TRUST_ICOCOAPI)/include/?g">>.tmp
echo "s?$TRUST_MED_ROOT/include/?\$(TRUST_MED_ROOT)/include/?g">>.tmp
echo "s?$TRUST_MEDCOUPLING_ROOT/include/?\$(TRUST_MEDCOUPLING_ROOT)/include/?g">>.tmp
echo "s?$TRUST_OSQP_ROOT/include/?\$(TRUST_OSQP_ROOT)/include/?g">>.tmp
echo "s?$PETSC_ROOT/$TRUST_ARCH$OPT/include/?\$(PETSC_ROOT)/\$(TRUST_ARCH)\$(OPT)/include/?g">>.tmp
echo > .tmp1
num=""
for dir in `cat $TRUST_ENV/rep.TRUST`
do
   dir=${dir#./}
   lh=`cd $TRUST_ROOT/$dir;ls *.h 2>/dev/null`
   if [ ${#lh} != 0 ]
   then
      [ "`cat .tmp$num | wc -l`" -gt 900 ] && num=1
      for file in $lh
      do
         ff=${file%.h}
         echo "s?include/$ff\.h?$dir/$ff\.h?g" >> .tmp$num
         if [ ! -L $file ] || [ "`ls -la $file | $TRUST_Awk '{print $NF}'`" != "../$dir/$file" ]
         then
            ln -sf ../$dir/$file $file 2>/dev/null
         fi
      done
   fi
   lh=`cd $TRUST_ROOT/$dir;ls *.tpp 2>/dev/null`
   if [ ${#lh} != 0 ]
   then
      [ "`cat .tmp$num | wc -l`" -gt 900 ] && num=1
      for file in $lh
      do
         ff=${file%.tpp}
         echo "s?include/$ff\.tpp?$dir/$ff\.tpp?g" >> .tmp$num
         if [ ! -L $file ] || [ "`ls -la $file | $TRUST_Awk '{print $NF}'`" != "../$dir/$file" ]
         then
            ln -sf ../$dir/$file $file 2>/dev/null
         fi
      done
   fi
done
# Supprime les liens inutiles
for file in `find . -name '*'.h -print`
do
   [ ! -f $file ] && rm -f $file
done
# Supprime les liens inutiles
for file in `find . -name '*'.tpp -print`
do
   [ ! -f $file ] && rm -f $file
done
