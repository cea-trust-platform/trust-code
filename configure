#!/bin/bash

[ ! -f ./configure ] && echo "`basename $0` must be run where it is located." && exit -1
TRUST_ROOT_SA=$TRUST_ROOT
export TRUST_ROOT=`pwd`
first=1
[ "$TRUST_ROOT" = "$TRUST_ROOT_SA" ] && [ "$TRUST_ENV" != "" ]  && first=0
mkdir -p lib exec env
( cd env; ln -sf ../env_src/* .)

# Check prerequis

bin/Installer_TRUST -check_prerequis || exit -1
export PATH=$PATH:$TRUST_ROOT/exec/utils/bin

###############################
# Clean old directories (<v169)
###############################
#reps="ALE EF Front_tracking_discontinu Kernel MAIN P1NCP1B Phase_field Rayonnement Rayonnement_semi_transp ThHyd ThSol UtilitairesAssemblages VDF VEF Zoom"
reps="EF Kernel MAIN P1NCP1B ThHyd ThSol VDF VEF"
for rep in $reps
do
   [ -d $rep ] && rm -r -f $rep
done

#########################################
# Creation des liens avec les autres VOBS
#########################################
#reps="../Tests_TRUST/tests ../Doc_TRUST/doc ../Pre_Post_TRUST/Outils"
reps=""
for rep in $reps
do 
   # Eventuelle substitution pour les VOBs en Noyau et non TRUST
   # Attention TRUST_Awk n'est pas encore defini...
   [ ! -d $rep ] && rep=`echo $rep | awk '{sub("TRUST","Noyau",$0);print $0}'`
   if [ -d $rep ]
   then
      r=`basename $rep`
      [ ! -d $r ]  && ln -sf $rep $r && echo "Link created: $rep ->" $r
   fi
done

if [ "$1" != "-disable-optionals" ] && [ "$1" != "-for_appli_salome" ]
then
echo "----------------------------------------------------------------------------------------------------------------------------"
echo "Usage: `basename $0` "
echo "[-help]                           Print help of the different configure options."
echo "[-disable-optionals]              Disable all optionals librairies and tools." 
echo "[-add_search=<dir>]               Add a directory to the defaults path to search a tool."
echo "[-c++=<prog>]                     Force the use of a specified C++ compiler."
echo "[-cc=<prog>]                      Force the use of a specified C compiler."
echo "[-fc=<prog>]                      Force the use of a specified Fortran compiler."
echo "[-cxxflags=<flags>]               Add C++ compiler options."
echo "[-cflags=<flags>]                 Add C compiler options."
echo "[-fflags=<flags>]                 Add Fortran compiler options."
echo "[-force_provided_mpich]           Use the provided MPICH `awk '/version=/ {gsub("version=","",$0);print $0}' ThirdPart/src/LIBMPI/Installer_mpich` version (default if a native and valid MPI is not found)."
echo "[-force_provided_openmpi]         Use the provided OpenMPI `awk '/default_version=/ {gsub("default_version=","",$0);print $0}' ThirdPart/src/LIBMPI/Installer_openmpi` version."
echo "[-force_old_openmpi]              Download and use the OpenMPI `awk '/old_version=/ {gsub("old_version=","",$0);print $0}' ThirdPart/src/LIBMPI/Installer_openmpi` version (valgrind free)."
#echo "[-force_latest_openmpi]           Download and use the OpenMPI `awk '/latest_version=/ {gsub("latest_version=","",$0);print $0}' ThirdPart/src/LIBMPI/Installer_openmpi` version."
echo "[-force_even_unsupported]         Force the configure even the compiler/OS is not supported."
#echo "[-force_petsc_have_cuda]          Use the latest PETSc version (petsc-dev) and try to activate the GPU support."
#echo "[-force_petsc_have_openmp]        Use the latest PETSc version (petsc-dev) and try to activate the OpenMP support."
echo "[-disable-petsc]                  Disable PETSc library installation."
echo "[-disable-med]                    Disable MED library installation."
echo "[-with-med=dir]                   Force Using external MED library"
echo "[-with-hdf=dir]                   Force Using external HDF library"
echo "[-disable-metis]                  Disable metis library installation."
echo "[-disable-medcoupling]            Disable MEDCoupling library installation."
echo "[-with-medcoupling=dir]           Force Using external MEDCoupling library"
echo "[-disable-mpi]                    Disable MPI library detection/installation and build a non-parallel version of the application."
echo "[-disable-ccache]                 Disable ccache detection/installation."
echo "[-disable-valgrind]               Disable valgrind installation and build."
echo "[-disable-gnuplot]                Disable gnuplot installation and build."
echo "[-disable-tcl_tk]                 Disable Tcl/Tk detection/installation."
echo "[-disable-gmsh]                   Disable Gmsh installation and build."
echo "[-disable-plot2d]                 Disable PLOT2D and WIZZARD installation and build."
echo "[-disable-mpiio]                  Disable MPI-IO mode for writing of .xyz binary output file."
echo "[-disable-check_sources]          No check sources before compiling."
echo "[-disable-checks]                 Disable checks for external packages, sources, disk space and speed."
echo "[-without-host_file]              Do not load the environnement variables specified in an env_src/HOST_`hostname | awk -F. '{print $1}'`.sh file."
echo "[-without-doc]                    Do not build the documentation."
echo "[-without-visit]                  Do not install VisIt."
echo "[-download-visit]                 Download a version of VisIt rather trying to build a version."
#echo "[-download-salome]                Download the Salome `awk -F= '/version_salome=/ {print $2}' env_src/configurer_env` version in the TRUST environment."
echo "[-for_appli_salome]               Force the configuration for TRUST application in Salome platform."
echo "[-clean]                          Clean the packages installed by configure."
echo "----------------------------------------------------------------------------------------------------------------------------"
fi
CC=""
cc=""
F77=""
clean=""

LIST_THIRD_PARTY="PETSC MED MPI METIS MEDCOUPLING CCACHE GMSH VALGRIND GNUPLOT TCL_TK PLOT2D"

#[ -f configure.log ] && sed "s/^/# /" -i  configure.log
[ -f configure.log ] && sed "s/# //" -i  configure.log && sed "s/^/# /" -i  configure.log
echo $0 $* "\$"* >> configure.log

if [ "$1" = "-for_appli_salome" ]
then
  shift
  export TRUST_ROOT=$TRUST_ROOT_SA
  $0 -disable-ccache -disable-gnuplot -disable-tcl_tk -disable-valgrind -without-visit -disable-gmsh -disable-checks -disable-check_sources -with-med=$MEDFILE_ROOT_DIR -with-hdf=$HDF5_ROOT_DIR -with-medcoupling=$MEDCOUPLING_ROOT_DIR $* 
  exit $?
fi
if [ "$1" = "-disable-optionals" ]
then
  shift
  export TRUST_ROOT=$TRUST_ROOT_SA
  $0 -disable-ccache -disable-med -disable-medcoupling -disable-petsc -disable-gnuplot -disable-tcl_tk -disable-valgrind -disable-mpi -disable-metis -without-visit -disable-gmsh -disable-plot2d -without-doc -disable-checks -disable-check_sources $* 
  exit $?
fi

for THIRD_PARTY in $LIST_THIRD_PARTY
do
  command=TRUST_DISABLE_$THIRD_PARTY=0   
  eval $command       
done
export TRUST_DISABLE_MPIIO=0
export TRUST_DISABLE_CHECK_SRC=0
export TRUST_DISABLE_CHECKS=0
export TRUST_WITHOUT_DOC=0
export TRUST_WITHOUT_VISIT=0
export TRUST_DOWNLOAD_VISIT=0
export TRUST_DOWNLOAD_SALOME=0
export TRUST_WITHOUT_HOST=0
unset TRUST_USE_EXTERNAL_HDF
unset TRUST_USE_EXTERNAL_MED
unset TRUST_USE_EXTERNAL_MEDCOUPLING

var=env/configure.env && rm -f $var
echo "$0 called with options: $*"

while [ "$1" != "" ]
do
   if [ "${1%-help}" != "$1" ]
   then
      exit
            
   elif [ "${1#-c++=}" != "$1" ]
   then
      export TRUST_FORCE_CC=${1#-c++=}
      
   elif [ "${1#-cc=}" != "$1" ]
   then
      export TRUST_FORCE_cc=${1#-cc=}
      
   elif [ "${1#-cxxflags=}" != "$1" ]
   then
      export TRUST_ADD_CXXFLAGS=${1#-cxxflags=}
      
   elif [ "${1#-cflags=}" != "$1" ]
   then
      export TRUST_ADD_CFLAGS=${1#-cflags=}
      
   elif [ "${1#-fflags=}" != "$1" ]
   then
      export TRUST_ADD_FFLAGS=${1#-fflags=}
         
   elif [ "${1#-fc=}" != "$1" ]
   then
      export TRUST_FORCE_F77=${1#-fc=}
      
   elif [ "${1#-add_search=}" != "$1" ]
   then
      export TRUST_FORCE_SEARCH=$TRUST_FORCE_SEARCH" "${1#-add_search=}
    elif [ "${1#-with-medcoupling=}" != "$1" ]
   then
      export TRUST_USE_EXTERNAL_MEDCOUPLING=${1#-with-medcoupling=}
        
   elif [ "${1#-with-med=}" != "$1" ]
   then
      export TRUST_USE_EXTERNAL_MED=${1#-with-med=}
      
   elif [ "${1#-with-hdf=}" != "$1" ]
   then
      export TRUST_USE_EXTERNAL_HDF=${1#-with-hdf=}
      
   elif [ "${1#-force_even_unsupported}" != "$1" ]
   then
      export TRUST_FORCE_SUPPORTED=1   
      
   elif [ "${1#-force_provided_openmpi}" != "$1" ]
   then
      export TRUST_FORCE_PROVIDED_OPENMPI=1
      
   elif [ "${1#-force_old_openmpi}" != "$1" ]
   then
      export TRUST_FORCE_OLD_OPENMPI=1

   elif [ "${1#-force_latest_openmpi}" != "$1" ]
   then
      export TRUST_FORCE_LATEST_OPENMPI=1

   elif [ "${1#-force_provided_mpich}" != "$1" ]
   then
      export TRUST_FORCE_PROVIDED_MPICH=1
      
   elif [ "${1#-force_petsc_have_cuda}" != "$1" ]
   then
      export TRUST_FORCE_PETSC_HAVE_CUDA=1
      
   elif [ "${1#-force_petsc_have_openmp}" != "$1" ]
   then
      export TRUST_FORCE_PETSC_HAVE_OPENMP=1

   elif [ "${1#-without-doc}" != "$1" ]
   then
      export TRUST_WITHOUT_DOC=1
      THIRD_PARTY="DOC"
      REP_THIRD_PARTY=$TRUST_ROOT/doc
      ([ -d $REP_THIRD_PARTY ] && [ $first -eq 0 ] && cd $REP_THIRD_PARTY && echo "Disabling $THIRD_PARTY, so make clean:" && make clean)

   elif [ "${1#-without-visit}" != "$1" ]
   then
      export TRUST_WITHOUT_VISIT=1
      THIRD_PARTY="VISIT"
      REP_THIRD_PARTY=$TRUST_ROOT/Outils/VisIt
      ([ -d $REP_THIRD_PARTY ] && [ $first -eq 0 ] && cd $REP_THIRD_PARTY && echo "Disabling $THIRD_PARTY, so make clean:" && make clean)
      
   elif [ "${1#-download-visit}" != "$1" ]
   then
      export TRUST_DOWNLOAD_VISIT=1  
       
   elif [ "${1#-download-salome}" != "$1" ]
   then
      export TRUST_DOWNLOAD_SALOME=1  
       
   elif [ "${1#-clean}" != "$1" ]
   then
      export clean="clean" 
       
   elif [ "${1#-disable-mpiio}" != "$1" ]
   then
      export TRUST_DISABLE_MPIIO=1 
       
   elif [ "${1#-disable-check_sources}" != "$1" ]
   then
      export TRUST_DISABLE_CHECK_SRC=1 

   elif [ "${1#-disable-checks}" != "$1" ]
   then
      export TRUST_DISABLE_CHECKS=1 
      export TRUST_DISABLE_CHECK_SRC=1 

   elif [ "${1#-disable-}" != "$1" ]
   then
      THIRD_PARTY=`echo ${1#-disable-} | awk '{print toupper($1)}'`
      
      REP_THIRD_PARTY=$TRUST_ROOT/ThirdPart/src/LIB$THIRD_PARTY
      [ "$THIRD_PARTY" = "GMSH" ] && REP_THIRD_PARTY=$TRUST_ROOT/Outils/Gmsh
      [ "$THIRD_PARTY" = "CCACHE" ] && REP_THIRD_PARTY=$TRUST_ROOT/env/ccache
      [ "$THIRD_PARTY" = "VALGRIND" ] && REP_THIRD_PARTY=$TRUST_ROOT/Outils/valgrind
      [ "$THIRD_PARTY" = "GNUPLOT" ] && REP_THIRD_PARTY=$TRUST_ROOT/Outils/gnuplot
      [ "$THIRD_PARTY" = "TCL_TK" ] && REP_THIRD_PARTY=$TRUST_ROOT/Outils/tcl_tk
      [ "$THIRD_PARTY" = "PLOT2D" ] && REP_THIRD_PARTY=$TRUST_ROOT/Outils/IHM
      if [ ! -d $REP_THIRD_PARTY ]
      then
         echo "$1 option not available cause $REP_THIRD_PARTY is not installed."
	 exit -1
      fi
      
      testv="echo \$TRUST_DISABLE_$THIRD_PARTY"
      res=`eval $testv`
      if [ "$res" = "" ] 
      then
	  echo "$1 option not available cause $THIRD_PARTY is not in list"
	  exit -1
      fi
      
      (cd $REP_THIRD_PARTY && [ $first -eq 0 ] && echo "Disabling $THIRD_PARTY, so make clean:" && make clean)
      command=TRUST_DISABLE_$THIRD_PARTY=1   
      eval $command

   elif [ "${1#-without-host_file}" != $1 ]
   then
      export TRUST_WITHOUT_HOST=1
       
   else   
      echo "Unknown option $1." 
      exit -1
   fi
   shift
done

export TRUST_ROOT_VERSION=`awk '/version/ && /Release notes/ {print $4;exit}' $TRUST_ROOT/RELEASE_NOTES | sed "s/_beta//"`
if [ "$TRUST_DISABLE_CHECKS" = 0 ] && [ "$clean" != "clean" ]
then
   [ ! -d externalpackages ] && [ ! -L externalpackages ] && echo "You need to download externalpackages before configuring" && echo wget http://downloads.sourceforge.net/project/trust-platform/$TRUST_ROOT_VERSION/externalpackages-$TRUST_ROOT_VERSION.tar && exit -1
   # Gestion externalpackages
   echo "Verify externalpackages..."
   cd $TRUST_ROOT/bin/gestion_externalpackages
   export LC_ALL=C && ./Verify_externalpackages.sh 
   [ $? != 0 ] && echo "" && echo "Error: You need to update externalpackages directory to $TRUST_ROOT_VERSION version" && exit -1
   cd $TRUST_ROOT
elif [ "$clean" != "clean" ]
then
   echo "Disabling CHECKS, so no verify externalpackages."
fi

for THIRD_PARTY in $LIST_THIRD_PARTY 
do
   VAR=TRUST_DISABLE_$THIRD_PARTY
   echo "$VAR=${!VAR} && export $VAR 	# Disable/enable $THIRD_PARTY"  					>> $var 
done
echo "TRUST_DISABLE_MPIIO=$TRUST_DISABLE_MPIIO && export TRUST_DISABLE_MPIIO	# Disable/enable MPI-IO mode for writing of binary output file"	>> $var
echo "TRUST_DISABLE_CHECK_SRC=$TRUST_DISABLE_CHECK_SRC && export TRUST_DISABLE_CHECK_SRC # No check sources before compiling"	>> $var
echo "TRUST_DISABLE_CHECKS=$TRUST_DISABLE_CHECKS && export TRUST_DISABLE_CHECKS	# Disable/enable checks for external packages, sources, disk space and speed" >> $var
echo "TRUST_WITHOUT_DOC=$TRUST_WITHOUT_DOC && export TRUST_WITHOUT_DOC		# Disable/enable Documentation"	>> $var
echo "TRUST_WITHOUT_VISIT=$TRUST_WITHOUT_VISIT && export TRUST_WITHOUT_VISIT	# Disable/enable VisIt" 	>> $var
echo "TRUST_DOWNLOAD_VISIT=$TRUST_DOWNLOAD_VISIT && export TRUST_DOWNLOAD_VISIT 	# Download or build VisIt" >> $var
echo "TRUST_DOWNLOAD_SALOME=$TRUST_DOWNLOAD_SALOME && export TRUST_DOWNLOAD_SALOME # Download Salome" 		>> $var   

if [ "$TRUST_USE_EXTERNAL_MEDCOUPLING" != "" ]  
then
    echo "export TRUST_USE_EXTERNAL_MEDCOUPLING=1" >> $var
    echo "export MEDCOUPLING_ROOT_DIR=$TRUST_USE_EXTERNAL_MEDCOUPLING" >> $var
else
    echo "unset TRUST_USE_EXTERNAL_MEDCOUPLING" >> $var
    # echo "unset MEDFILE_ROOT_DIR" >> $var
fi
if [ "$TRUST_USE_EXTERNAL_MED" != "" ]  
then
    echo "export TRUST_USE_EXTERNAL_MED=1" >> $var
    echo "export MEDFILE_ROOT_DIR=$TRUST_USE_EXTERNAL_MED" >> $var
else
    echo "unset TRUST_USE_EXTERNAL_MED" >> $var
    # echo "unset MEDFILE_ROOT_DIR" >> $var
fi
if [ "$TRUST_USE_EXTERNAL_HDF" != "" ]  
then
    echo "export TRUST_USE_EXTERNAL_HDF=1" >> $var
    echo "export HDF5_ROOT_DIR=$TRUST_USE_EXTERNAL_HDF" >> $var
else
    echo "unset  TRUST_USE_EXTERNAL_HDF" >> $var
    #echo "unset HDF5_ROOT_DIR" >> $var
fi


################################
# Check options for some hosts #
################################
HOST=`hostname`

####################################################
# Configuration et initialisation de l'environnement
####################################################
rm -f env_TRUST.sh env/env_TRUST.sh
sed "s?TRUST_ROOT=path_to_trio?TRUST_ROOT=$TRUST_ROOT?" env_src/env_TRUST.sh.in > env/env_TRUST.sh
chmod gou+x env/env_TRUST.sh
ln -sf env/env_TRUST.sh .

cd env
./configurer_env $clean || exit -1
[ "$clean" != "" ] && exit 0
cd ..
source ./env_TRUST.sh 1>/dev/null 2>&1

###############################################
# Verification des performances de TRUST_TMP #
###############################################
if [ "$TRUST_DISABLE_CHECKS" = 0 ]
then
   dd.ksh -speed $TRUST_TMP -silent
   if [ $? != 0 ]
   then
      echo "TRUST_TMP=$TRUST_TMP"
      echo "Please, specify a directory for the TRUST_TMP variable in the $perso file"
      echo "in order to have good performances for TRUST." 
   fi
fi

##########################################
# Creation d'un Makefile sous $TRUST_ROOT
##########################################
cd $TRUST_ROOT
if [ "$clean" = "" ]
then
   # echo $ECHO_OPTS "all:\n\tcompile" 				> $TRUST_ROOT/Makefile
   echo $ECHO_OPTS "all:\n\t(. ./env_TRUST.sh ;env cibles=\"micro_kernel_opt numeric_kernel_opt standard_kernel_opt opt micro_kernel_debug numeric_kernel_debug standard_kernel_debug debug\" monodir)"  > $TRUST_ROOT/Makefile
   echo $ECHO_OPTS "tools:\n\t(. ./env_TRUST.sh ;compile tools)" >> $TRUST_ROOT/Makefile
   echo  $ECHO_OPTS "optim:\t opt" 	>> $TRUST_ROOT/Makefile
   for cible in opt debug prof gcov opt_avx semi_opt custom
   do
     echo $ECHO_OPTS "${cible}:\n\t(. ./env_TRUST.sh ;env cibles=\"micro_kernel_${cible} numeric_kernel_${cible} standard_kernel_${cible} ${cible}\" monodir)" >> $TRUST_ROOT/Makefile
   done
   echo $ECHO_OPTS "clean:\n\t(. ./env_TRUST.sh ;compile clean)" >> $TRUST_ROOT/Makefile
   echo $ECHO_OPTS "depend:\n\t#fait_makefile" 			>> $TRUST_ROOT/Makefile
   echo $ECHO_OPTS "doxygen:\n\t(. ./env_TRUST.sh ;make_Doxyfile)" 			>> $TRUST_ROOT/Makefile
   #echo $ECHO_OPTS "init:\n\t. ./env_TRUST.sh" 		>> $TRUST_ROOT/Makefile
   echo $ECHO_OPTS "check:\n\t(. ./env_TRUST.sh ;echo 0 | lance_test $exec_opt $TRUST_ROOT )" >> $TRUST_ROOT/Makefile  
   echo $ECHO_OPTS "check_optim:\tcheck" >> $TRUST_ROOT/Makefile  
   echo $ECHO_OPTS "check_debug:\n\t(. ./env_TRUST.sh ;echo 0 | lance_test $exec_debug $TRUST_ROOT )" >> $TRUST_ROOT/Makefile  
   [ "${#ECHO_OPTS}" = 0 ] && echo "Error: Check "$TRUST_ROOT"/Makefile !!! (ECHO_OPTS="$ECHO_OPTS")" && exit -1
   ##################################
   # Desormais on recree les makefile
   ##################################   
   #make depend 
   echo $ECHO_OPTS "File Makefile created."
   echo $ECHO_OPTS "File configure.log created."
   echo
   echo $ECHO_OPTS "# To initialize the TRUST environment, run:"
   echo $ECHO_OPTS "source env_TRUST.sh"
   echo $ECHO_OPTS "# To build TRUST, run:"
   echo $ECHO_OPTS "make"
   echo $ECHO_OPTS "# To check TRUST, run:"
   echo $ECHO_OPTS "make check"
fi
exit 0
